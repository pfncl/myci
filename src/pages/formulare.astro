---
export const prerender = false;

import BaseLayout from '../layouts/BaseLayout.astro';
import { ADMIN_PASSWORD, TURNSTILE_SECRET_KEY } from 'astro:env/server';

type Order = {
  id: number;
  services: string;
  company_name: string;
  email: string;
  phone: string;
  street: string;
  city: string;
  zip: string;
  service_date: string | null;
  notes: string | null;
  created_at: string;
};

const COOKIE_NAME = 'admin_session';

// Generate a session token from the password
async function hashToken(password: string): Promise<string> {
  const data = new TextEncoder().encode(password + ':myci-admin-salt');
  const hash = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
}

const expectedToken = await hashToken(ADMIN_PASSWORD);
let authenticated = false;
let loginError = '';
let orders: Order[] = [];

// Handle POST (login / logout)
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'logout') {
    return new Response(null, {
      status: 302,
      headers: {
        Location: '/formulare',
        'Set-Cookie': `${COOKIE_NAME}=; Path=/; Max-Age=0; HttpOnly; Secure; SameSite=Strict`,
      },
    });
  }

  if (action === 'delete') {
    const sessionCookie = Astro.cookies.get(COOKIE_NAME)?.value;
    if (sessionCookie === expectedToken) {
      const orderId = formData.get('orderId');
      if (orderId) {
        const db = Astro.locals.runtime.env.DB;
        await db.prepare('DELETE FROM orders WHERE id = ?').bind(orderId).run();
      }
      return new Response(null, {
        status: 302,
        headers: { Location: '/formulare' },
      });
    }
  }

  // Verify Turnstile
  const turnstileToken = formData.get('cf-turnstile-response') as string;
  if (turnstileToken) {
    const tsRes = await fetch('https://challenges.cloudflare.com/turnstile/v0/siteverify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ secret: TURNSTILE_SECRET_KEY, response: turnstileToken }),
    });
    const tsResult = await tsRes.json() as { success: boolean };
    if (!tsResult.success) {
      loginError = 'Ověření selhalo. Zkuste to znovu.';
    }
  } else {
    loginError = 'Ověření selhalo. Zkuste to znovu.';
  }

  const password = formData.get('password') as string;
  if (!loginError && password === ADMIN_PASSWORD) {
    const token = await hashToken(password);
    return new Response(null, {
      status: 302,
      headers: {
        Location: '/formulare',
        'Set-Cookie': `${COOKIE_NAME}=${token}; Path=/; Max-Age=${60 * 60 * 24 * 7}; HttpOnly; Secure; SameSite=Strict`,
      },
    });
  } else if (!loginError) {
    loginError = 'Nesprávné heslo.';
  }
}

// Check session cookie
const cookie = Astro.cookies.get(COOKIE_NAME)?.value;
if (cookie === expectedToken) {
  authenticated = true;
}

// Load orders if authenticated
if (authenticated) {
  const db = Astro.locals.runtime.env.DB;
  const result = await db.prepare('SELECT * FROM orders ORDER BY created_at DESC').all<Order>();
  orders = result.results;
}
---

<BaseLayout title="Formuláře – Myči.CZ" description="Správa objednávek">
  <meta slot="head" name="robots" content="noindex, nofollow" />
  <div class="admin-page">
    {authenticated ? (
      <div class="admin-content">
        <div class="admin-header">
          <h1>Přijaté objednávky ({orders.length})</h1>
          <form method="POST">
            <input type="hidden" name="action" value="logout" />
            <button type="submit" class="btn-logout">Odhlásit se</button>
          </form>
        </div>

        {orders.length === 0 ? (
          <p class="empty">Zatím žádné objednávky.</p>
        ) : (
          <div class="orders-list">
            {orders.map((order) => (
              <details class="order-card">
                <summary class="order-summary">
                  <span class="order-id">#{order.id}</span>
                  <span class="order-company">{order.company_name}</span>
                  <time>{new Date(order.created_at + 'Z').toLocaleString('cs-CZ', { timeZone: 'Europe/Prague' })}</time>
                </summary>
                <div class="order-details">
                  <div class="order-row">
                    <strong>Služby:</strong> {order.services}
                  </div>
                  <div class="order-row">
                    <strong>E-mail:</strong> <a href={`mailto:${order.email}`}>{order.email}</a>
                  </div>
                  <div class="order-row">
                    <strong>Telefon:</strong> <a href={`tel:${order.phone}`}>{order.phone}</a>
                  </div>
                  <div class="order-row">
                    <strong>Adresa:</strong> {order.street}, {order.city} {order.zip}
                  </div>
                  {order.service_date && (
                    <div class="order-row">
                      <strong>Datum:</strong> {order.service_date}
                    </div>
                  )}
                  {order.notes && (
                    <div class="order-row">
                      <strong>Poznámky:</strong> {order.notes}
                    </div>
                  )}
                  <form method="POST" class="order-delete" onsubmit="return confirm('Opravdu smazat objednávku?')">
                    <input type="hidden" name="action" value="delete" />
                    <input type="hidden" name="orderId" value={order.id} />
                    <button type="submit" class="btn-delete">Smazat</button>
                  </form>
                </div>
              </details>
            ))}
          </div>
        )}
      </div>
    ) : (
      <div class="login-box">
        <h1>Přihlášení</h1>
        {loginError && <p class="login-error">{loginError}</p>}
        <form method="POST">
          <label for="password">Heslo</label>
          <input type="password" id="password" name="password" required autofocus />
          <div class="turnstile-field">
            <div class="cf-turnstile" data-sitekey="0x4AAAAAACb2orZs8ymvai7p" data-theme="light" data-language="cs"></div>
          </div>
          <button type="submit" class="btn-login">Přihlásit se</button>
        </form>
        <script is:inline src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
      </div>
    )}
  </div>
</BaseLayout>

<style>
  .admin-page {
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 20px;
    min-height: 60vh;
  }

  /* Login */
  .login-box {
    max-width: 360px;
    margin: 80px auto;
    padding: 30px;
    border: 2px solid #4FA4DB;
    border-radius: 6px;
    background: #fff;
  }

  .login-box h1 {
    font-size: 22px;
    margin: 0 0 20px;
    color: #333;
    text-align: center;
  }

  .login-box label {
    display: block;
    font-size: 14px;
    color: #555;
    margin-bottom: 6px;
  }

  .login-box input {
    width: 100%;
    padding: 10px 12px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin-bottom: 16px;
    box-sizing: border-box;
  }

  .turnstile-field {
    margin-bottom: 16px;
  }

  .btn-login {
    width: 100%;
    padding: 12px;
    background: #4FA4DB;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
  }

  .btn-login:hover {
    background: #3d8ec5;
  }

  .login-error {
    color: #dd3333;
    text-align: center;
    margin-bottom: 16px;
    font-size: 14px;
  }

  /* Admin content */
  .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .admin-header h1 {
    font-size: 24px;
    color: #333;
    margin: 0;
  }

  .btn-logout {
    padding: 8px 16px;
    background: #eee;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    color: #555;
  }

  .btn-logout:hover {
    background: #ddd;
  }

  .empty {
    color: #888;
    text-align: center;
    padding: 40px 0;
    font-size: 16px;
  }

  /* Order cards */
  .orders-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .order-card {
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    background: #fff;
  }

  .order-summary {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 20px;
    font-size: 14px;
    color: #555;
    cursor: pointer;
    list-style: none;
  }

  .order-summary::-webkit-details-marker {
    display: none;
  }

  .order-summary::before {
    content: '▸';
    font-size: 12px;
    color: #aaa;
    transition: transform 0.15s;
  }

  .order-card[open] > .order-summary::before {
    transform: rotate(90deg);
  }

  .order-id {
    font-weight: 600;
    color: #4FA4DB;
  }

  .order-company {
    flex: 1;
    font-weight: 600;
    color: #333;
  }

  .order-summary time {
    font-size: 13px;
    color: #888;
  }

  .order-details {
    padding: 0 20px 16px;
    border-top: 1px solid #f0f0f0;
  }

  .order-row {
    padding: 4px 0;
    font-size: 15px;
    line-height: 1.5;
  }

  .order-row strong {
    color: #555;
    min-width: 100px;
    display: inline-block;
  }

  .order-row a {
    color: #4FA4DB;
    text-decoration: none;
  }

  .order-row a:hover {
    text-decoration: underline;
  }

  .order-delete {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #f0f0f0;
    text-align: right;
  }

  .btn-delete {
    padding: 6px 14px;
    background: #fff;
    color: #cc3333;
    border: 1px solid #cc3333;
    border-radius: 4px;
    font-size: 13px;
    cursor: pointer;
  }

  .btn-delete:hover {
    background: #cc3333;
    color: #fff;
  }

  @media (max-width: 600px) {
    .admin-page {
      padding: 20px 12px;
    }

    .order-card {
      padding: 12px;
    }

    .admin-header h1 {
      font-size: 20px;
    }
  }
</style>
